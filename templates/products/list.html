{% extends 'base.html' %}
{% block title %}Products — Stationery POS{% endblock %}
{% block breadcrumb %}Products{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-white">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
      <h3 class="m-0">Products</h3>
      <div class="d-flex flex-wrap gap-2">
        <a href="{% url 'stock_bulk_adjust' %}" class="btn btn-outline-warning">
          <i class="bi bi-upload me-1"></i> Bulk Stock (CSV)
        </a>
        <a href="{% url 'stock_add' %}" class="btn btn-outline-primary">
          <i class="bi bi-plus-square-dotted me-1"></i> Add Stock
        </a>
        <a href="{% url 'product_barcodes' %}" class="btn btn-outline-dark">
          <i class="bi bi-upc-scan me-1"></i> Print Barcodes
        </a>
        <a href="{% url 'product_export' %}" class="btn btn-outline-secondary">
          <i class="bi bi-download me-1"></i> Export CSV
        </a>

        {# Import CSV button opens modal #}
        <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#importCsvModal">
          <i class="bi bi-filetype-csv me-1"></i> Import CSV
        </button>

        <a href="{% url 'product_create' %}" class="btn btn-success">
          <i class="bi bi-plus-circle me-1"></i> New Product
        </a>
      </div>
    </div>

    <div class="mt-3">
      <form class="row g-2 align-items-center">
        <div class="col-sm-6">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" name="q" value="{{ q }}" placeholder="Search by name / code / barcode">
          </div>
        </div>
        <div class="col-sm-3">
          <select name="page_size" id="page_size" class="form-select">
            {% with ps=page_size|default:25 %}
              <option value="10"  {% if ps|add:0 == 10 %}selected{% endif %}>10 per page</option>
              <option value="25"  {% if ps|add:0 == 25 %}selected{% endif %}>25 per page</option>
              <option value="50"  {% if ps|add:0 == 50 %}selected{% endif %}>50 per page</option>
              <option value="100" {% if ps|add:0 == 100 %}selected{% endif %}>100 per page</option>
            {% endwith %}
          </select>
        </div>
        <div class="col-sm-3">
          <button class="btn btn-outline-secondary w-100">
            <i class="bi bi-filter-circle me-1"></i> Apply
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead>
          <tr>
            <th style="min-width:110px;">Code</th>
            <th style="min-width:120px;">Barcode</th>
            <th>Name</th>
            <th>Category</th>
            <th class="text-end" style="width:120px;">Unit Price</th>
            <th class="text-end" style="width:120px;">Cost</th>
            <th class="text-end" style="width:90px;">Tax %</th>
            <th class="text-end" style="width:110px;">Stock</th>
            <th style="width:160px;"></th>
          </tr>
        </thead>
        <tbody>
          {% for p in page_obj %}
          <tr>
            <td class="font-monospace">
              <span class="me-1">{{ p.code }}</span>
              <button type="button" class="btn btn-link btn-sm text-secondary copy-btn" data-copy="{{ p.code }}" title="Copy code">
                <i class="bi bi-clipboard"></i>
              </button>
            </td>
            <td class="font-monospace">
              {% if p.barcode %}
                <span class="me-1">{{ p.barcode }}</span>
                <button type="button" class="btn btn-link btn-sm text-secondary copy-btn" data-copy="{{ p.barcode }}" title="Copy barcode">
                  <i class="bi bi-clipboard"></i>
                </button>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              <div class="fw-semibold">{{ p.name }}</div>
              {% if not p.is_active %}
                <span class="badge rounded-pill text-bg-secondary">Inactive</span>
              {% endif %}
            </td>
            <td>{{ p.category }}</td>
            <td class="text-end">₹ {{ p.unit_price|floatformat:2 }}</td>
            <td class="text-end">₹ {{ p.cost_price|floatformat:2 }}</td>
            <td class="text-end">{{ p.tax_percent|floatformat:2 }}</td>
            <td class="text-end">
              {% with s=p.stock rl=p.reorder_level %}
                {% if s <= 0 %}
                  <span class="badge text-bg-danger">{{ s }}</span>
                {% elif rl and s|add:0 <= rl|add:0 %}
                  <span class="badge text-bg-warning">{{ s }}</span>
                {% else %}
                  <span class="badge text-bg-success">{{ s }}</span>
                {% endif %}
              {% endwith %}
            </td>
            <td class="text-end">
              <div class="btn-group">
                <a class="btn btn-sm btn-outline-primary" href="{% url 'product_add_stock' p.id %}">
                  <i class="bi bi-boxes me-1"></i> Stock
                </a>
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'product_update' p.id %}">
                  <i class="bi bi-pencil-square me-1"></i> Edit
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="9" class="text-center py-5">
              <div class="text-muted mb-2"><i class="bi bi-inboxes"></i> No products found</div>
              <a href="{% url 'product_create' %}" class="btn btn-sm btn-success">
                <i class="bi bi-plus-circle me-1"></i> Create your first product
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="card-footer bg-white">
    {% include "partials/pagination.html" with page_obj=page_obj base_qs=base_qs page_size=page_size %}
  </div>
</div>

{# ------- Import CSV Modal ------- #}
<div class="modal fade" id="importCsvModal" tabindex="-1" aria-labelledby="importCsvModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="post" action="{% url 'product_import' %}" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="modal-header">
          <h5 class="modal-title" id="importCsvModalLabel"><i class="bi bi-filetype-csv me-2"></i>Import Products (CSV)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">CSV file</label>
            <input type="file" name="file" accept=".csv" class="form-control" required>
          </div>
          <div class="small text-muted">
            <div class="mb-1"><strong>Columns:</strong> <code>code</code>, <code>barcode</code>, <code>name</code>, <code>category</code>, <code>unit_price</code>, <code>cost_price</code>, <code>tax_percent</code>, <code>reorder_level</code>, <code>is_active</code></div>
            <div>Tip: Export once via <b>Export CSV</b> to get the exact header and formats.</div>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          <button type="button" class="btn btn-outline-secondary" id="btnDownloadSample">
            <i class="bi bi-download me-1"></i> Download sample CSV
          </button>
          <div>
            <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
            <button class="btn btn-primary"><i class="bi bi-upload me-1"></i>Import</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

{# Clipboard + page size helper + sample CSV generator #}
<script>
(function(){
  // Copy-to-clipboard for code/barcode
  document.addEventListener('click', function(e){
    const btn = e.target.closest('.copy-btn');
    if (!btn) return;
    const txt = btn.getAttribute('data-copy') || '';
    if (!txt) return;
    if (navigator.clipboard && window.isSecureContext) {
      navigator.clipboard.writeText(txt).then(function(){
        btn.classList.add('text-success');
        setTimeout(()=>btn.classList.remove('text-success'), 600);
      }).catch(()=>alert('Copy failed'));
    } else {
      const ta = document.createElement('textarea');
      ta.value = txt; document.body.appendChild(ta); ta.select();
      try { document.execCommand('copy'); btn.classList.add('text-success'); setTimeout(()=>btn.classList.remove('text-success'), 600); }
      catch (_) { alert('Copy failed'); }
      document.body.removeChild(ta);
    }
  });

  // Auto-submit when page size changes (keeps search text)
  const sel = document.getElementById('page_size');
  if (sel) {
    sel.addEventListener('change', function(){
      const form = sel.closest('form');
      if (form) form.submit();
    });
  }

  // Generate & download sample CSV (no backend needed)
  const sampleBtn = document.getElementById('btnDownloadSample');
  if (sampleBtn) {
    sampleBtn.addEventListener('click', function(){
      const rows = [
        ["code","barcode","name","category","unit_price","cost_price","tax_percent","reorder_level","is_active"],
        ["PEN-001","8901234567890","Ball Pen Blue","Pens","10.00","6.00","12.00","20","1"],
        ["NOTE-A5","","Notebook A5 Ruled","Notebooks","60.00","40.00","12.00","15","1"]
      ];
      const csv = rows.map(r => r.map(cell => {
        const s = String(cell ?? "");
        return (s.includes(',') || s.includes('"') || s.includes('\n')) ? `"${s.replace(/"/g,'""')}"` : s;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'product_import_sample.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  }
})();
</script>
{% endblock %}
