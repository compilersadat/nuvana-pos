{% extends 'base.html' %}
{% block title %}Barcode Labels — Stationery POS{% endblock %}
{% block breadcrumb %}<a href="{% url 'product_list' %}" class="text-decoration-none">Products</a> / Barcode Labels{% endblock %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-white d-flex align-items-center justify-content-between">
    <h5 class="m-0"><i class="bi bi-upc me-2"></i>Barcode Labels (A4)</h5>
    <a class="btn btn-sm btn-light" href="{% url 'product_list' %}"><i class="bi bi-arrow-left me-1"></i>Back to products</a>
  </div>
  <form method="post">
    {% csrf_token %}
    <div class="card-body">
      <p class="text-muted small mb-3">Choose a grid and symbology. EAN‑13 requires a 12/13‑digit number; we’ll compute the check digit if needed. If invalid, we fall back to Code 128.</p>
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Label Grid (A4)</label>
          <select name="tpl" id="tpl" class="form-select">
            <option value="a4_3x8">3 × 8 (default)</option>
            <option value="a4_3x7">Avery L7160 — 3 × 7</option>
            <option value="a4_4x12">Compact — 4 × 12</option>
            <option value="a4_5x13">Tiny — 5 × 13</option>
            <option value="custom">Custom…</option>
          </select>
        </div>
        <div class="col-md-2 custom-fields d-none">
          <label class="form-label">Cols</label>
          <input type="number" class="form-control" name="cols" min="1" value="3">
        </div>
        <div class="col-md-2 custom-fields d-none">
          <label class="form-label">Rows</label>
          <input type="number" class="form-control" name="rows" min="1" value="8">
        </div>
        <div class="col-md-1 custom-fields d-none">
          <label class="form-label">Left mm</label>
          <input type="number" step="0.1" class="form-control" name="ml" value="10">
        </div>
        <div class="col-md-1 custom-fields d-none">
          <label class="form-label">Right mm</label>
          <input type="number" step="0.1" class="form-control" name="mr" value="10">
        </div>
        <div class="col-md-1 custom-fields d-none">
          <label class="form-label">Top mm</label>
          <input type="number" step="0.1" class="form-control" name="mt" value="10">
        </div>
        <div class="col-md-1 custom-fields d-none">
          <label class="form-label">Bottom mm</label>
          <input type="number" step="0.1" class="form-control" name="mb" value="13">
        </div>

        <div class="col-md-2">
          <label class="form-label">Symbology</label>
          <select name="sym" class="form-select">
            <option value="code128">Code 128 (versatile)</option>
            <option value="ean13">EAN‑13 (12/13 digits)</option>
          </select>
        </div>
      </div>

      <hr>

      <div class="table-responsive" style="max-height:60vh;">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th style="width:60px">Pick</th>
              <th>Code</th>
              <th>Barcode</th>
              <th>Name</th>
              <th class="text-end">Price</th>
              <th style="width:100px">Qty</th>
            </tr>
          </thead>
          <tbody>
            {% for p in products %}
            <tr>
              <td>
                <input class="form-check-input select-row" type="checkbox">
                <input type="hidden" name="product_id" value="{{ p.id }}" disabled>
              </td>
              <td class="fw-semibold">{{ p.code }}</td>
              <td class="text-muted">{{ p.barcode|default:"(uses code)" }}</td>
              <td>{{ p.name }}</td>
              <td class="text-end">₹ {{ p.unit_price }}</td>
              <td>
                <input type="number" name="qty" value="1" min="0" class="form-control form-control-sm qty" disabled>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="card-footer bg-white d-flex gap-2">
      <button class="btn btn-primary"><i class="bi bi-printer me-1"></i>Download PDF</button>
      <a class="btn btn-light" href="{% url 'product_list' %}">Cancel</a>
    </div>
  </form>
</div>

<script>
const tpl = document.getElementById('tpl');
const toggleCustom = () => {
  document.querySelectorAll('.custom-fields').forEach(el => {
    el.classList.toggle('d-none', tpl.value !== 'custom');
  });
};
tpl.addEventListener('change', toggleCustom);
toggleCustom();

document.querySelectorAll('.select-row').forEach(chk => {
  chk.addEventListener('change', (e) => {
    const tr = e.target.closest('tr');
    const qty = tr.querySelector('.qty');
    const hidden = tr.querySelector('input[type="hidden"][name="product_id"]');
    if (e.target.checked) {
      qty.disabled = false;
      hidden.disabled = false;
      if (!qty.value || qty.value === "0") qty.value = "1";
    } else {
      qty.disabled = true;
      hidden.disabled = true;
    }
  });
});
</script>
{% endblock %}
