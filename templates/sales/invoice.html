{% extends 'base.html' %}
{% load static %}
{% block title %}{{ sale.is_return|yesno:"Credit Note,Invoice" }} #{{ sale.is_return|yesno:"CRN,INV" }}-{{ sale.id }} — Stationery POS{% endblock %}

{% block content %}
<div class="d-print-none mb-3 d-flex justify-content-between align-items-center">
  <a href="javascript:history.back()" class="btn btn-light"><i class="bi bi-arrow-left"></i> Back</a>
  <div class="d-flex gap-2">
    <button class="btn btn-outline-secondary" onclick="window.print()"><i class="bi bi-printer"></i> Print</button>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">

    <!-- Header (Org block) -->
    <div class="d-flex justify-content-between align-items-start">
      <div class="d-flex align-items-start gap-3">
        <img src="{% static 'logo.png' %}" alt="Logo" style="height:56px; width:auto;" onerror="this.style.display='none'">
        <div>
          <h4 class="mb-1">{{ org_name|default:"Your Organization Name" }}</h4>
          <div class="text-muted small">
            {{ org_address|default:"Street, City, State, ZIP" }}<br>
            <span>Phone:</span> {{ org_phone|default:"000-000-0000" }}
            {% if org_email %} | <span>Email:</span> {{ org_email }}{% endif %}
          </div>
        </div>
      </div>
      <div class="text-end">
        <div class="fw-semibold">{{ sale.is_return|yesno:"Credit Note,Invoice" }}</div>
        <div class="h5 mb-0">{{ sale.is_return|yesno:"CRN,INV" }}-{{ sale.id }}</div>
        <div class="text-muted">Date: {{ sale.date }}</div>
      </div>
    </div>

    <hr>

    <!-- Bill-to / Payment summary -->
    <div class="row g-3 mb-2">
      <div class="col-md-7">
        <div class="border rounded p-2">
          <div class="fw-semibold mb-1">Bill To</div>
          {% if sale.customer %}
            <div>{{ sale.customer.name }}</div>
            {% if sale.customer.phone %}<div class="text-muted small">{{ sale.customer.phone }}</div>{% endif %}
            {% if sale.customer.email %}<div class="text-muted small">{{ sale.customer.email }}</div>{% endif %}
          {% else %}
            <div class="text-muted">Walk-in customer</div>
          {% endif %}
        </div>
      </div>
      <div class="col-md-5">
        <div class="border rounded p-2">
          <div class="fw-semibold mb-1">Payment</div>
          <div class="d-flex justify-content-between"><span>Method</span><span>{{ sale.get_payment_method_display }}</span></div>
          <div class="d-flex justify-content-between"><span>Paid</span><span>₹ {{ sale.paid_amount|floatformat:2 }}</span></div>
        </div>
      </div>
    </div>

    <!-- Items -->
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Item</th>
            <th class="text-end" style="width:90px">Qty</th>
            <th class="text-end" style="width:120px">Price</th>
            <th class="text-end" style="width:100px">Tax %</th>
            <th class="text-end" style="width:120px">Tax</th>
            <th class="text-end" style="width:140px">Line Total</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr>
            <td>{{ it.product.name }}</td>
            <td class="text-end">{{ it.qty }}</td>
            <td class="text-end">₹ {{ it.unit_price|floatformat:2 }}</td>
            <td class="text-end">{{ it.tax_percent|floatformat:2 }}</td>
            <td class="text-end">₹ {{ it.tax_amount|floatformat:2 }}</td>
            <td class="text-end">₹ {{ it.line_total|floatformat:2 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Totals -->
    <div class="row">
      <div class="col-md-6">
        {% if sale.notes %}
          <div class="small text-muted">Notes:</div>
          <div class="border rounded p-2 small">{{ sale.notes }}</div>
        {% endif %}
      </div>
      <div class="col-md-6">
        <div class="ms-auto" style="max-width:360px">
          <div class="d-flex justify-content-between"><span>Subtotal</span><span>₹ {{ sale.subtotal|floatformat:2 }}</span></div>
          <div class="d-flex justify-content-between"><span>Discount</span><span>₹ {{ sale.discount|floatformat:2 }}</span></div>
          <div class="d-flex justify-content-between"><span>Tax</span><span>₹ {{ sale.tax|floatformat:2 }}</span></div>
          <hr class="my-2">
          <div class="d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Grand Total</span>
            <span class="fw-bold fs-5">₹ {{ sale.total|floatformat:2 }}</span>
          </div>
          {% if sale.is_return %}
            <div class="text-danger text-end small mt-1">Credit note amounts are negative.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <hr>

    <!-- Footer -->
    <div class="d-flex justify-content-between align-items-end">
      <div class="small text-muted">
        Thank you for your business.<br>
        Keep this {{ sale.is_return|yesno:"credit note,invoice" }} for your records.
      </div>
      <div class="text-end small text-muted">
        {{ org_name|default:"Your Organization Name" }} • {{ org_phone|default:"000-000-0000" }}{% if org_email %} • {{ org_email }}{% endif %}<br>
        <span class="text-muted">Powered by Stationery POS</span>
      </div>
    </div>

  </div>
</div>

<style>
  @media print {
    .navbar, .d-print-none, .btn, .alert { display: none !important; }
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .card { border: none !important; box-shadow: none !important; }
    .table thead.table-light th { background: #f6f7f9 !important; -webkit-print-color-adjust: exact; }
  }
</style>
{% endblock %}
