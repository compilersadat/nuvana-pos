{% extends 'base.html' %}
{% load widget_tweaks %}
{% block title %}Point of Sale â€” Stationery POS{% endblock %}
{% block breadcrumb %}POS{% endblock %}

{% block content %}
<form method="post" id="pos-form" novalidate>
  {% csrf_token %}
  <div class="row g-3">
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <h3 class="mb-0">
              {% if editing %}Edit {{ form.instance.is_return|yesno:"Credit Note,Invoice" }} #{{ form.instance.is_return|yesno:"CRN,INV" }}-{{ form.instance.id }}
              {% else %}Point of Sale{% endif %}
            </h3>
            <span class="badge bg-secondary">Scan or search</span>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddRow">
              <i class="bi bi-plus-circle me-1"></i>Add Item
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="btnClear">
              <i class="bi bi-trash me-1"></i>Clear
            </button>
          </div>
        </div>
        <input type="hidden" name="items_json" id="items_json" value="{{ items_json|default:''|escape }}">


        <div class="card-body">
          <div class="mb-3">
            <label class="form-label" for="quick_scan">Quick scan / search</label>
            <input id="quick_scan" class="form-control" placeholder="Scan barcode or type code/name, then Enter"
                   list="products" autocomplete="off" inputmode="search">
            <div class="form-text">Tip: Press <kbd>F2</kbd> to focus here. Press <kbd>Enter</kbd> to add the item.</div>
          </div>

          <div class="row g-3 mb-2">
            <div class="col-md-6">
              <label class="form-label">Customer</label>
              {{ form.customer|add_class:"form-select" }}
            </div>
            <div class="col-md-3">
              <label class="form-label">Date</label>
              {{ form.date|add_class:"form-control" }}
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check">
                {{ form.is_return|add_class:"form-check-input"|attr:"id:id_is_return" }}
                <label class="form-check-label" for="id_is_return">Return</label>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-sm align-middle" id="items-table">
              <thead class="sticky-top bg-white">
                <tr>
                  <th>Product</th>
                  <th style="width:120px">Qty</th>
                  <th style="width:150px">Price</th>
                  <th style="width:150px">Line Total</th>
                  <th style="width:50px"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

       
          <div id="pos_error" class="alert alert-warning mt-2 d-none"></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-4">
      <div class="card shadow-sm" style="position:sticky; top:1rem;">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
          <h6 class="m-0">Totals</h6>
          <small class="text-muted">auto tax per product</small>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-1"><span>Subtotal</span><span id="subtotal">0.00</span></div>
          <div class="mb-2">
            <div class="d-flex justify-content-between align-items-center">
              <label class="m-0" for="id_discount">Discount</label>
              <div style="width:160px">
                {{ form.discount|add_class:"form-control form-control-sm"|attr:"step:0.01"|attr:"min:0" }}
              </div>
            </div>
            <div class="text-end small text-muted"><span id="discount">0.00</span> applied</div>
          </div>
          <div class="d-flex justify-content-between mb-2"><span>Tax</span><span id="tax">0.00</span></div>
          <hr class="my-2">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">Grand Total</div>
            <div class="fw-bold fs-5"><span id="grand_total">0.00</span></div>
          </div>
          <div class="form-text text-end">Totals turn negative for returns.</div>

          <hr class="my-3">

          <div class="mb-2">
            <label class="form-label" for="id_payment_method">Payment method</label>
            {{ form.payment_method|add_class:"form-select" }}
          </div>
          <div class="mb-2">
            <label class="form-label" for="id_paid_amount">Paid amount</label>
            {{ form.paid_amount|add_class:"form-control"|attr:"step:0.01"|attr:"min:0" }}
          </div>
          <button class="btn btn-success w-100 mt-2" id="btnComplete">
            <i class="bi bi-check2-circle me-1"></i>
            {% if editing %}Update{% else %}Complete{% endif %} {{ form.is_return.value|yesno:"Return,Sale" }}
          </button>
          <div class="text-center small text-muted mt-2">Shortcut: <kbd>F9</kbd> or <kbd>Ctrl</kbd> + <kbd>Enter</kbd></div>
        </div>
      </div>
    </div>
  </div>
</form>

<datalist id="products">
  {% for p in products %}
    <option
      data-id="{{ p.id }}"
      data-code="{{ p.code }}"
      data-price="{{ p.unit_price }}"
      data-barcode="{{ p.barcode }}"
      data-tax="{{ p.tax_percent }}"
      data-stock="{{ p.stock_sum|default:0 }}"
      value="{{ p.code }} - {{ p.name }}{% if p.barcode %} ({{ p.barcode }}){% endif %}">
    </option>
  {% endfor %}
</datalist>

{# Prefill item rows when editing an existing sale #}
{% if editing and prefill_items %}
<script>
document.addEventListener('DOMContentLoaded', function(){
  console.log("item");
  try {
    const data = {{ prefill_items|safe }};
    const tbody = document.querySelector('#items-table tbody');
    if (tbody) tbody.innerHTML = '';
    if (Array.isArray(data)) {
      data.forEach(function(it){
        addItemRow('sale');
        const tr = document.querySelector('#items-table tbody tr:last-child');
        if (!tr) return;
        const p = tr.querySelector('.product-input');
        const q = tr.querySelector('.qty-input');
        const u = tr.querySelector('.price-input');
        if (p) p.value = it.display || '';
        if (q) q.value = it.qty || 1;
        if (u) u.value = (parseFloat(it.unit_price || 0)).toFixed(2);
      });
      recalcTotals();
    }
  } catch(e) {}
});
</script>
{% endif %}
{% endblock %}
